---
- name: Enable archlinux multilib repository
  ansible.builtin.blockinfile:
    path: /etc/pacman.conf
    block: |
      [multilib]
      Include = /etc/pacman.d/mirrorlist
    marker: '# {mark} ANSIBLE MANAGED BLOCK - multilib'
    state: present
  become: yes
  notify: pacman_refresh

- name: Force handlers run
  meta: flush_handlers

- name: Install steam and dependencies packages
  community.general.pacman:
    name: "{{ steam_packages }}"
    state: present

- name: Install AUR packages
  kewlfft.aur.aur:
    name: "{{ item }}"
    use: yay
    state: present
  become: true
  become_user: "{{ base_user.username }}"
  loop: "{{ steam_aur_packages }}"

- name: Create heroic wrapper script
  ansible.builtin.copy:
    src: heroic-wrapper.sh
    dest: /usr/bin/heroic-wrapper.sh
    owner: root
    group: root
    mode: '0755'

- name: Override heroic desktop
  ansible.builtin.copy:
    src: heroic.desktop
    dest: "{{ base_user.homedir  }}/.local/share/applications/heroic.desktop"
    owner: "{{ base_user.username }}"
    group: "{{ base_user.username }}"
    mode: '0640'
    directory_mode: '0750'
  become: true
  become_user: "{{ base_user.username }}"
  notify: desktop_database_refresh

- name: Create gamescope desktop entry
  ansible.builtin.copy:
    src: steam-big-picture.desktop
    dest: /usr/share/wayland-sessions/steam-big-picture.desktop
    owner: root
    group: root
    mode: '0755'
